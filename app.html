<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>JekyllChess PGN App</title>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>

<!-- Chess libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">

<style>
* { box-sizing: border-box; }

html, body {
  margin: 0;
  height: 100%;
  background: #0f1115;
  color: #e6e6e6;
  font-family: system-ui, -apple-system, sans-serif;
}

/* ---------- TOP BAR ---------- */
.topbar {
  min-height: 52px;
  padding: 0 14px;
  display: flex;
  align-items: center;
  gap: 10px;
  background: #171a21;
  border-bottom: 1px solid #222;
}

.brand {
  display: flex;
  align-items: center;
  gap: 10px;
}

.brand img {
  width: 22px;
  height: 22px;
  filter: invert(1);
}

.title {
  font-weight: 700;
}

/* ---------- LAYOUT ---------- */
.app {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

.main {
  flex: 1;
  display: flex;
  flex-direction: column;
}

/* ---------- BOARD ---------- */
.board-wrap {
  padding: 12px;
}

#board {
  width: min(92vw, 560px);
  margin: 0 auto;
}

/* ---------- CONTROLS ---------- */
.controls {
  padding: 0 12px 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.controls-row {
  display: flex;
  gap: 6px;
}

.controls button {
  flex: 1;
  padding: 10px 0;
  border: none;
  border-radius: 10px;
  background: #1f2430;
  color: #ddd;
  font-size: 15px;
}

.controls button:disabled {
  opacity: .4;
}

/* ---------- RIGHT PANE ---------- */
.pane { display: none; }
.pane.active { display: block; }

/* ---------- TABS ---------- */
.tabs {
  display: flex;
  border-bottom: 1px solid #222;
}

.tab {
  flex: 1;
  text-align: center;
  padding: 10px;
  cursor: pointer;
  background: #141820;
}

.tab.active {
  background: #1f2430;
  font-weight: 600;
}

/* ---------- MOVES ---------- */
.moves {
  padding: 16px;
  overflow-y: auto;
  line-height: 2.2;
  font-size: 18px;
}

.move {
  cursor: pointer;
  padding: 2px 6px;
  border-radius: 6px;
  display: inline-block;
}

.move.active {
  background: #3a7afe;
  color: #fff;
}

.comment {
  margin: 4px 0 10px 20px;
  padding-left: 8px;
  border-left: 3px solid #3a7afe;
  font-size: 15px;
  color: #cfd6ff;
}

/* ---------- VARIATIONS ---------- */
.variation {
  margin: 6px 0 12px 28px;
  padding-left: 10px;
  border-left: 2px dashed #444;
  font-size: 16px;
  opacity: .92;
}

.variation .move {
  background: #1a1f2b;
  margin-right: 4px;
}

/* ---------- PGN ---------- */
.pgn-wrap {
  padding: 12px;
}

textarea {
  width: 100%;
  height: 260px;
  background: #0f1115;
  color: #e6e6e6;
  border: 1px solid #222;
  border-radius: 8px;
  padding: 10px;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  font-size: 14px;
  resize: vertical;
}

/* ---------- DESKTOP ---------- */
@media (min-width: 900px) {
  .main {
    display: grid;
    grid-template-columns: 560px 1fr;
  }
}
</style>
</head>

<body>

<div class="app">

  <div class="topbar">
    <div class="brand">
      <img src="https://jekyllchess.github.io/assets/favicon.png" alt="">
      <div class="title">JekyllChess PGN App</div>
    </div>
  </div>

  <div class="main">

    <!-- LEFT -->
    <div>
      <div class="board-wrap">
        <div id="board"></div>
      </div>

      <div class="controls">
        <div class="controls-row">
          <button id="btnFirst">⏮</button>
          <button id="btnPrev">◀</button>
          <button id="btnPlay">▶</button>
          <button id="btnNext">▶</button>
          <button id="btnLast">⏭</button>
        </div>

        <div class="controls-row">
          <button id="btnFlip">↺ Flip</button>
          <button id="btnCopyPGN">Copy PGN</button>
          <button id="btnCopyFEN">Copy FEN</button>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div>
      <div class="tabs">
        <div class="tab active" data-tab="moves">Moves</div>
        <div class="tab" data-tab="pgn">PGN</div>
      </div>

      <div id="movesPane" class="pane active">
        <div class="moves" id="moves"></div>
      </div>

      <div id="pgnPane" class="pane">
        <div class="pgn-wrap">
          <textarea id="pgnText" placeholder="Enter or paste PGN here…"></textarea>
          <div class="controls-row" style="margin-top:8px">
            <button id="btnCopyPGN2">Copy PGN</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
(() => {
  const FIG = { K:"♔", Q:"♕", R:"♖", B:"♗", N:"♘" };

  const chess = new Chess();
  const movesDiv = document.getElementById("moves");
  const pgnText = document.getElementById("pgnText");

  const board = Chessboard("board", {
    position: "start",
    draggable: true,
    pieceTheme: "https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png",
    onDrop
  });

  function figSAN(s) {
    return s.replace(/^[KQRBN]/, p => FIG[p])
            .replace(/=([QRBN])/g, (_,p)=>"="+FIG[p]);
  }

  function splitMainAndVariations(pgn) {
    const vars = [];
    let out = "", buf = "", depth = 0;
    for (const ch of pgn) {
      if (ch === "(") {
        if (++depth === 1) buf = "";
        else buf += ch;
      } else if (ch === ")") {
        if (--depth === 0) vars.push(buf.trim());
        else buf += ch;
      } else {
        depth ? buf += ch : out += ch;
      }
    }
    return { main: out, variations: vars };
  }

  function render() {
    movesDiv.innerHTML = "";

    const { main, variations } = splitMainAndVariations(pgnText.value);

    chess.reset();
    if (main.trim()) chess.load_pgn(main, { sloppy:true });

    const mainHist = chess.history({ verbose:true });

    mainHist.forEach((m,i) => {
      const span = document.createElement("span");
      span.className = "move";
      span.textContent =
        (m.color==="w"?`${Math.floor(i/2)+1}. `:"") + figSAN(m.san) + " ";
      span.onclick = () => gotoMain(mainHist, i);
      movesDiv.appendChild(span);

      if (m.comment) {
        const c = document.createElement("div");
        c.className = "comment";
        c.textContent = m.comment;
        movesDiv.appendChild(c);
      }
    });

    variations.forEach(v => {
      const vDiv = document.createElement("div");
      vDiv.className = "variation";
      const vc = new Chess();
      vc.load_pgn(v,{sloppy:true});
      vc.history({verbose:true}).forEach((m,i)=>{
        const s=document.createElement("span");
        s.className="move";
        s.textContent=figSAN(m.san);
        s.onclick=()=>{
          vc.reset();
          vc.history({verbose:true}).slice(0,i+1).forEach(x=>vc.move(x));
          board.position(vc.fen(),true);
        };
        vDiv.appendChild(s);
        vDiv.appendChild(document.createTextNode(" "));
      });
      movesDiv.appendChild(vDiv);
    });

    board.position(chess.fen(), true);
  }

  function gotoMain(hist,i){
    chess.reset();
    hist.slice(0,i+1).forEach(m=>chess.move(m));
    board.position(chess.fen(),true);
  }

  function onDrop(from,to){
    const m = chess.move({from,to,promotion:"q"});
    if(!m) return "snapback";
    pgnText.value = chess.pgn();
    render();
  }

  $(".tab").on("click",function(){
    $(".tab,.pane").removeClass("active");
    $(this).addClass("active");
    $("#"+$(this).data("tab")+"Pane").addClass("active");
  });

  document.getElementById("btnFlip").onclick =
    () => board.orientation(board.orientation()==="white"?"black":"white");

  document.getElementById("btnCopyPGN").onclick =
  document.getElementById("btnCopyPGN2").onclick =
    () => navigator.clipboard.writeText(pgnText.value);

  document.getElementById("btnCopyFEN").onclick =
    () => navigator.clipboard.writeText(chess.fen());

  pgnText.onblur = render;

  render();
  window.addEventListener("resize",()=>board.resize());
})();
</script>

</body>
</html>
