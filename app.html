<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>JekyllChess PGN App</title>

<!-- jQuery REQUIRED by chessboard.js -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#0f1115;
  color:#e6e6e6;
  font-family:system-ui,-apple-system,sans-serif;
}
.wrap{padding:12px;display:flex;flex-direction:column;gap:10px}
#board{width:min(92vw,560px);margin:0 auto}

.moves{font-size:18px;line-height:2.1}
.move{
  display:inline-block;
  padding:2px 6px;
  border-radius:7px;
  cursor:pointer;
}
.move.active{background:#3a7afe;color:#fff}

.variation{
  margin:6px 0 10px 26px;
  padding-left:10px;
  border-left:2px dashed #444;
}

.commentRow{
  margin:4px 0 10px 18px;
  padding:6px 8px;
  border-left:3px solid #3a7afe;
  background:#121724;
  font-size:14px;
}

/* contextual menu */
#moveMenu{
  position:absolute;
  display:none;
  background:#141820;
  border:1px solid #2a3150;
  border-radius:10px;
  padding:6px;
  gap:6px;
  z-index:1000;
}
#moveMenu button{
  background:#1f2430;
  border:none;
  border-radius:8px;
  padding:6px 8px;
  font-size:16px;
  color:#ddd;
  cursor:pointer;
}
#moveMenu button:hover{background:#2a3150}
</style>
</head>

<body>

<div class="wrap">
  <div id="board"></div>
  <div class="moves" id="moves"></div>
</div>

<div id="moveMenu">
  <button id="menuPromote">â¬†</button>
  <button id="menuComment">âž•</button>
  <button id="menuDelete">ðŸ—‘</button>
</div>

<script>
(() => {
const FIG={K:"â™”",Q:"â™•",R:"â™–",B:"â™—",N:"â™˜"};
const figSAN=s=>s.replace(/^[KQRBN]/,p=>FIG[p]||p).replace(/=([QRBN])/g,(_,p)=>"="+FIG[p]);

let NODE_SEQ=1;
const byId=new Map();

class Node{
  constructor(san,parent){
    this.id="n"+NODE_SEQ++;
    this.san=san;
    this.comment="";
    this.parent=parent;
    this.next=null;
    this.variations=[];
    byId.set(this.id,this);
  }
}

const root=new Node(null,null);
let cursor=root;
let activeNode=null;

const chess=new Chess();
const board=Chessboard("board",{position:"start",draggable:true,onDrop});

function rebuildTo(n){
  chess.reset();
  const chain=[];
  while(n&&n!==root){chain.push(n);n=n.parent}
  chain.reverse().forEach(m=>chess.move(m.san));
  board.position(chess.fen(),true);
}

const movesDiv=document.getElementById("moves");
const menu=document.getElementById("moveMenu");
const btnPromote=document.getElementById("menuPromote");
const btnDelete=document.getElementById("menuDelete");
const btnComment=document.getElementById("menuComment");

function renderLine(start,container,ply){
  let n=start.next;
  while(n){
    const span=document.createElement("span");
    span.className="move";
    span.textContent=((ply%2===0)?`${Math.floor(ply/2)+1}. `:"")+figSAN(n.san)+" ";
    span.onclick=(e)=>{
      e.stopPropagation();
      document.querySelectorAll(".move").forEach(m=>m.classList.remove("active"));
      span.classList.add("active");
      activeNode=n;
      rebuildTo(n);
      showMenu(e.pageX,e.pageY,n);
    };
    container.appendChild(span);

    if(n.comment){
      const c=document.createElement("div");
      c.className="commentRow";
      c.textContent=n.comment;
      container.appendChild(c);
    }

    n.variations.forEach(v=>{
      const vDiv=document.createElement("div");
      vDiv.className="variation";
      renderVariation(v,vDiv,ply);
      container.appendChild(vDiv);
    });

    n=n.next;
    ply++;
  }
}

function renderVariation(vRoot,container,ply){
  const span=document.createElement("span");
  span.className="move";
  span.textContent=((ply%2===0)?`${Math.floor(ply/2)+1}. `:`${Math.floor(ply/2)+1}... `)+figSAN(vRoot.san)+" ";
  span.onclick=(e)=>{
    e.stopPropagation();
    activeNode=vRoot;
    rebuildTo(vRoot);
    showMenu(e.pageX,e.pageY,vRoot);
  };
  container.appendChild(span);

  if(vRoot.comment){
    const c=document.createElement("div");
    c.className="commentRow";
    c.textContent=vRoot.comment;
    container.appendChild(c);
  }

  renderLine(vRoot,container,ply+1);
}

function renderAll(){
  movesDiv.innerHTML="";
  renderLine(root,movesDiv,0);
}

function showMenu(x,y,node){
  menu.style.left=x+"px";
  menu.style.top=y+"px";
  menu.style.display="flex";

  btnPromote.style.display =
    node.parent && node.parent.variations.includes(node) ? "inline-flex" : "none";
}

document.body.onclick=()=>menu.style.display="none";

btnDelete.onclick=()=>{
  if(!activeNode||activeNode===root)return;
  const p=activeNode.parent;
  if(p.next===activeNode)p.next=null;
  p.variations=p.variations.filter(v=>v!==activeNode);
  activeNode=null;
  menu.style.display="none";
  rebuildTo(p);
  renderAll();
};

btnComment.onclick=()=>{
  if(!activeNode)return;
  const txt=prompt("Comment:",activeNode.comment||"");
  if(txt!==null)activeNode.comment=txt.replace(/\}/g,"").trim();
  menu.style.display="none";
  renderAll();
};

btnPromote.onclick=()=>{
  const p=activeNode.parent;
  p.variations=p.variations.filter(v=>v!==activeNode);
  const old=p.next;
  if(old)p.variations.unshift(old);
  p.next=activeNode;
  activeNode.parent=p;
  menu.style.display="none";
  renderAll();
};

async function onDrop(from,to){
  let promotion="q";
  if(chess.get(from).type==="p"&&(to[1]==="8"||to[1]==="1")){
    promotion=prompt("Promote to (q,r,b,n):","q")||"q";
  }
  const m=chess.move({from,to,promotion});
  if(!m)return"snapback";

  let next;
  if(cursor.next&&cursor.next.san===m.san)next=cursor.next;
  else{
    next=new Node(m.san,cursor);
    if(!cursor.next)cursor.next=next;
    else cursor.variations.push(next);
  }
  cursor=next;
  board.position(chess.fen(),false);
  renderAll();
}

renderAll();
})();
</script>

</body>
</html>
