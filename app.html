<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>JekyllChess PGN App</title>

<!-- jQuery REQUIRED -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>

<!-- Chess libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">

<style>
*{box-sizing:border-box}
body{margin:0;background:#0f1115;color:#e6e6e6;font-family:system-ui}
.top{padding:10px 14px;background:#171a21;border-bottom:1px solid #222;display:flex;gap:10px}
.top img{width:22px;filter:invert(1)}
.wrap{padding:12px}
.main{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:900px){.main{grid-template-columns:560px 1fr}}
.controls{display:flex;gap:6px;justify-content:center}
.controls button{padding:10px;border:none;border-radius:10px;background:#1f2430;color:#ddd}
.card{border:1px solid #222;border-radius:12px}
.card .head{padding:10px;background:#141820;border-bottom:1px solid #222;display:flex;justify-content:space-between}
.tabs{display:flex;gap:6px}
.tabBtn{border:none;background:#1f2430;color:#ddd;padding:6px 10px;border-radius:999px}
.tabBtn.active{background:#3a7afe;color:#fff}
.moves{font-size:18px;line-height:2.1}
.move{display:inline-block;padding:2px 6px;border-radius:7px;cursor:pointer}
.move.active{background:#3a7afe;color:#fff}
.variation{margin-left:26px;border-left:2px dashed #444;padding-left:10px}
.commentRow{margin:4px 0 10px 18px;padding:6px 8px;border-left:3px solid #3a7afe;background:#121724}
.pgnBox{width:100%;height:320px;background:#0f1115;color:#e6e6e6;border:1px solid #222;border-radius:12px;padding:12px}
#pop{position:fixed;display:none;background:#141820;border:1px solid #2a3150;border-radius:10px;padding:8px;z-index:1000}
#pop .row{display:flex;gap:6px}
#pop button{background:#1f2430;border:none;border-radius:8px;padding:6px 8px;color:#ddd}
</style>
</head>

<body>

<div class="top">
  <img src="https://jekyllchess.github.io/assets/favicon.png">
  <div>JekyllChess PGN App</div>
</div>

<div class="wrap">
<div class="main">

<div>
  <div id="board"></div>
  <div class="controls">
    <button id="btnStart">⏮</button>
    <button id="btnPrev">◀</button>
    <button id="btnNext">▶</button>
    <button id="btnEnd">⏭</button>
  </div>
</div>

<div class="card">
  <div class="head">
    <div>Move list</div>
    <div class="tabs">
      <button id="tabMoves" class="tabBtn active">Move list</button>
      <button id="tabPGN" class="tabBtn">PGN text</button>
    </div>
  </div>
  <div class="body">
    <div id="panelMoves"><div id="moves" class="moves"></div></div>
    <div id="panelPGN" style="display:none">
      <textarea id="pgnText" class="pgnBox"></textarea>
    </div>
  </div>
</div>

</div>
</div>

<div id="pop"></div>

<script>
(() => {
  const FIG={K:"♔",Q:"♕",R:"♖",B:"♗",N:"♘"};
  const figSAN=s=>s.replace(/^[KQRBN]/,p=>FIG[p]||p).replace(/=([QRBN])/g,(_,p)=>"="+FIG[p]);

  let NODE=1;
  class Node{
    constructor(san,parent){
      this.id="n"+NODE++;
      this.san=san;
      this.parent=parent;
      this.next=null;
      this.variations=[];
      this.comment="";
    }
  }

  const root=new Node(null,null);
  let cursor=root;
  let navNode=null;

  const chess=new Chess();
  const board=Chessboard("board",{
    position:"start",
    draggable:true,
    pieceTheme:"https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png",
    onDrop
  });

  const movesDiv=document.getElementById("moves");
  const pgnText=document.getElementById("pgnText");

  /* -------- VARIATION-CORRECT MOVE INSERTION -------- */
  function addMoveToTree(san){
    // 1. If mainline exists and matches → follow
    if(cursor.next && cursor.next.san===san){
      cursor=cursor.next;
      return;
    }

    // 2. If a variation with same SAN exists → follow it
    const existingVar=cursor.variations.find(v=>v.san===san);
    if(existingVar){
      cursor=existingVar;
      return;
    }

    // 3. If mainline exists but differs → create variation
    const newNode=new Node(san,cursor);

    if(cursor.next){
      cursor.variations.push(newNode);
    }else{
      cursor.next=newNode;
    }

    cursor=newNode;
  }

  function rebuild(n){
    chess.reset();
    const a=[];
    while(n&&n!==root){a.push(n);n=n.parent}
    a.reverse().forEach(m=>chess.move(m.san));
    board.position(chess.fen(),false);
  }

  function render(){
    movesDiv.innerHTML="";
    function line(start,ply){
      let n=start.next;
      while(n){
        const s=document.createElement("span");
        s.className="move";
        s.textContent=((ply%2===0)?Math.floor(ply/2)+1+". ":"")+figSAN(n.san)+" ";
        s.onclick=()=>{
          cursor=n;
          rebuild(n);
          render();
        };
        movesDiv.appendChild(s);

        if(n.variations.length){
          n.variations.forEach(v=>{
            const d=document.createElement("div");
            d.className="variation";
            const vs=document.createElement("span");
            vs.className="move";
            vs.textContent=figSAN(v.san)+" ";
            vs.onclick=()=>{
              cursor=v;
              rebuild(v);
              render();
            };
            d.appendChild(vs);
            line(v,ply+1);
            movesDiv.appendChild(d);
          });
        }

        n=n.next; ply++;
      }
    }
    line(root,0);
    pgnText.value=serialize()+" *";
  }

  function serialize(){
    function s(node,ply){
      let out=[],n=node.next;
      while(n){
        if(ply%2===0) out.push(Math.floor(ply/2)+1+".");
        out.push(n.san);
        n.variations.forEach(v=>{
          out.push("("+s({next:v},ply+1)+")");
        });
        n=n.next; ply++;
      }
      return out.join(" ");
    }
    return s(root,0);
  }

  /* -------- DROP -------- */
  function onDrop(from,to){
    const test=new Chess(chess.fen());
    const m=test.move({from,to,promotion:"q"});
    if(!m) return "snapback";

    chess.move(m.san);
    addMoveToTree(m.san);
    rebuild(cursor);
    render();
  }

  render();
})();
</script>

</body>
</html>
