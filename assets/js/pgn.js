!function(){"use strict";if("function"!=typeof Chess||!window.PGNCore)return;var e=window.PGNCore,t="function"==typeof window.Chessboard,n=0;function d(e,t){if(!e||!t||!window.Chessboard)return;var d="pgn-diagram-"+n++,o=document.createElement("div");o.className="pgn-diagram",o.id=d,e.appendChild(o);try{Chessboard(d,{position:t,draggable:!1,pieceTheme:e.PIECE_THEME_URL})}catch(e){}}function r(t){return e.SAN_CORE_REGEX.test(t)}function o(e){var t=e.split(/\r?\n/),n=[],d=[],r=!0;return t.forEach(function(e){var t=e.trim();r&&t.startsWith("[")&&t.endsWith("]")?n.push(e):r&&""===t?r=!1:(r=!1,d.push(e))}),{headers:n,moveText:d.join(" ").replace(/\s+/g," ").trim()}}function a(e,t){t&&e.appendChild(document.createTextNode(t))}function i(t){this.sourceEl=t,this.wrapper=document.createElement("div"),this.wrapper.className="pgn-blog-block",this.finalResultPrinted=!1,this.build(),this.applyFigurines()}i.prototype.build=function(){var t="";try{t=this.sourceEl.textContent.trim()}catch(e){return}t=e.normalizeFigurines(t);var n=o(t),d=n.headers,r=n.moveText,a=(d.length?d.join("\n")+"\n\n":"")+r,i=new Chess;try{i.load_pgn(a,{sloppy:!0})}catch(e){}var s={};try{s=i.header?i.header():{}}catch(e){}var l=e.normalizeResult(s.Result||""),c=/ (1-0|0-1|1\/2-1\/2|½-½|\*)$/.test(r),u=c?r:r+(l?" "+l:"");this.header(s),this.parse(u);try{this.sourceEl.replaceWith(this.wrapper)}catch(e){this.sourceEl.parentNode&&this.sourceEl.parentNode.replaceChild(this.wrapper,this.sourceEl)}},i.prototype.header=function(t){var n=document.createElement("h3"),d=(t.WhiteTitle?t.WhiteTitle+" ":"")+e.flipName(t.White||"")+(t.WhiteElo?" ("+t.WhiteElo+")":""),r=(t.BlackTitle?t.BlackTitle+" ":"")+e.flipName(t.Black||"")+(t.BlackElo?" ("+t.BlackElo+")":""),o=e.extractYear(t.Date),i=(t.Event||"")+(o?", "+o:"");a(n,d+" – "+r),n.appendChild(document.createElement("br")),a(n,i),this.wrapper.appendChild(n)},i.prototype.ensure=function(e,t){e.container||(e.container=document.createElement("p"),e.container.className=t,this.wrapper.appendChild(e.container))},i.prototype.parseComment=function(t,n,r){for(var o=n;o<t.length&&"}"!==t[o];)o++;var a=t.substring(n,o).trim();"}"===t[o]&&o++,a=a.replace(/\[%.*?]/g,"").trim();if(!a.length)return o;for(var i=a.split("[D]"),s=0;s<i.length;s++){var l=i[s].trim();if("variation"===r.type){this.ensure(r,"pgn-variation"),l&&a(r.container," "+l)}else{if(l){var c=document.createElement("p");c.className="pgn-comment",a(c,l),this.wrapper.appendChild(c)}r.container=null}s<i.length-1&&d(this.wrapper,r.chess.fen())}return r.lastWasInterrupt=!0,o},i.prototype.handleSAN=function(t,n){var d=t.replace(/[^a-hKQRBN0-9=O0-]+$/g,"").replace(/0/g,"O");if(!r(d))return a(n.container,t+" "),null;var o=n.baseHistoryLen||0,i=n.chess.history().length,s=o+i,l=0==s%2,c=Math.floor(s/2)+1;l?a(n.container,c+"."+e.NBSP):n.lastWasInterrupt&&a(n.container,c+"..."+e.NBSP),n.prevFen=n.chess.fen(),n.prevHistoryLen=s;var u=null;try{u=n.chess.move(d,{sloppy:!0})}catch(e){}if(!u)return a(n.container,t+" "),null;n.lastWasInterrupt=!1;var p=document.createElement("span");return p.className="pgn-move",p.textContent=e.makeCastlingUnbreakable(t)+" ",n.container.appendChild(p),p},i.prototype.parse=function(t){var n=new Chess,r={type:"main",chess:n,container:null,parent:null,lastWasInterrupt:!1,prevFen:n.fen(),prevHistoryLen:0,baseHistoryLen:null},o=0;for(;o<t.length;){var i=t[o];if(/\s/.test(i)){for(;o<t.length&&/\s/.test(t[o]);)o++;this.ensure(r,"main"===r.type?"pgn-mainline":"pgn-variation"),a(r.container," ");continue}if("("===i){o++;var s=r.prevFen||r.chess.fen(),l="number"==typeof r.prevHistoryLen?r.prevHistoryLen:r.chess.history().length;r={type:"variation",chess:new Chess(s),container:null,parent:r,lastWasInterrupt:!0,prevFen:s,prevHistoryLen:l,baseHistoryLen:l},this.ensure(r,"pgn-variation");continue}if(")"===i){o++,r.parent&&(r=r.parent,r.lastWasInterrupt=!0,r.container=null);continue}if("{"===i){o=this.parseComment(t,o+1,r);continue}for(var c=o;o<t.length&&!/\s/.test(t[o])&&-1==="(){}".indexOf(t[o]);)o++;var u=t.substring(c,o);if(!u)continue;if(/^\[%.*]$/.test(u))continue;if("[D]"===u){d(this.wrapper,r.chess.fen()),r.lastWasInterrupt=!0,r.container=null;continue}if(e.RESULT_REGEX.test(u)){this.finalResultPrinted||(this.finalResultPrinted=!0,this.ensure(r,"main"===r.type?"pgn-mainline":"pgn-variation"),a(r.container,u+" "));continue}if(e.MOVE_NUMBER_REGEX.test(u))continue;var p=u.replace(/[^a-hKQRBN0-9=O0-]+$/g,"").replace(/0/g,"O"),m=r(p);if(!m){if(e.EVAL_MAP[u]){this.ensure(r,"main"===r.type?"pgn-mainline":"pgn-variation"),a(r.container,e.EVAL_MAP[u]+" ");continue}if("$"===u[0]){var f=+u.slice(1);e.NAG_MAP[f]&&(this.ensure(r,"main"===r.type?"pgn-mainline":"pgn-variation"),a(r.container,e.NAG_MAP[f]+" "));continue}if(/[A-Za-zÇĞİÖŞÜçğıöşü]/.test(u))"variation"===r.type?(this.ensure(r,"pgn-variation"),a(r.container," "+u)):(function(){var t=document.createElement("p");t.className="pgn-comment",a(t,u),this.wrapper.appendChild(t)}).call(this),r.container=null,r.lastWasInterrupt=!1;else this.ensure(r,"main"===r.type?"pgn-mainline":"pgn-variation"),a(r.container,u+" ");continue}this.ensure(r,"main"===r.type?"pgn-mainline":"pgn-variation");var h=this.handleSAN(u,r);h||a(r.container,e.makeCastlingUnbreakable(u)+" ")}} ,i.prototype.applyFigurines=function(){if(this.wrapper.__pgnFigurined)return;this.wrapper.__pgnFigurined=!0;var e={K:"♔",Q:"♕",R:"♖",B:"♗",N:"♘"};this.wrapper.querySelectorAll(".pgn-move").forEach(function(t){var n=t.textContent.match(/^([KQRBN])(.+?)(\s*)$/);n&&(t.textContent=e[n[1]]+n[2]+(n[3]||""))})};function s(){document.querySelectorAll("pgn").forEach(function(e){e.__pgnRendered||(e.__pgnRendered=!0,new i(e))})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",s,{once:!0}):s()}();
