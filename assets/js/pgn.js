(()=>{"use strict";const e="https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png",t=/^([O0]-[O0](-[O0])?[+#]?|[KQRBN]?[a-h]?[1-8]?x?[a-h][1-8](=[QRBN])?[+#]?|[a-h][1-8](=[QRBN])?[+#]?)$/,n=/^(1-0|0-1|1\/2-1\/2|½-½|\*)$/,s=/^(\d+)(\.+)$/,i="\u00A0",r=/^[\+\-=∞±]+$/,a={1:"!",2:"?",3:"‼",4:"⁇",5:"⁉",6:"⁈",13:"→",14:"↑",15:"⇆",16:"⇄",17:"⟂",18:"∞",19:"⟳",20:"⟲",36:"⩲",37:"⩱",38:"±",39:"∓",40:"+=",41:"=+",42:"±",43:"∓",44:"⨀",45:"⨁"};let o=0;function l(){return"undefined"!=typeof Chess||(console.warn("pgn.js: chess.js missing"),!1)}function c(e){return e?e.replace(/1\/2-1\/2/g,"½-½"):""}function h(e){if(!e)return"";let t=e.split(".");return/^\d{4}$/.test(t[0])?t[0]:""}function d(e){if(!e)return"";let t=e.indexOf(",");return-1===t?e.trim():e.slice(t+1).trim()+" "+e.slice(0,t).trim()}function p(e,t){t&&e.appendChild(document.createTextNode(t))}function u(t,n){if("undefined"==typeof Chessboard)return void console.warn("pgn.js: chessboard.js missing");let s="pgn-diagram-"+o++,i=document.createElement("div");i.className="pgn-diagram",i.id=s,i.style.width="340px",i.style.maxWidth="100%",t.appendChild(i),setTimeout(()=>{let t=document.getElementById(s);t&&Chessboard(t,{position:n,draggable:!1,pieceTheme:e})},0)}function g(e){return e.replace(/0-0-0|O-O-O/g,(e=>e[0]+"\u2011"+e[2]+"\u2011"+e[4])).replace(/0-0|O-O/g,(e=>e[0]+"\u2011"+e[2]))}class f{constructor(e){this.sourceEl=e,this.wrapper=document.createElement("div"),this.wrapper.className="pgn-blog-block",this.finalResultPrinted=!1,this.build(),this.applyFigurines()}static isSANCore(e){return t.test(e)}static split(e){let t=e.split(/\r?\n/),n=[],s=[],i=!0;for(let r of t){let t=r.trim();i&&t.startsWith("[")&&t.endsWith("]")?n.push(r):i&&""===t?i=!1:(i=!1,s.push(r))}return{headers:n,moveText:s.join(" ").replace(/\s+/g," ").trim()}}build(){let e=this.sourceEl.textContent.trim(),{headers:t,moveText:n}=f.split(e),s=(t.length?t.join("\n")+"\n\n":"")+n,i=new Chess;i.load_pgn(s,{sloppy:!0});let r=i.header(),a=c(r.Result||""),o=/ (1-0|0-1|1\/2-1\/2|½-½|\*)$/.test(n),l=o?n:n+(a?" "+a:"");this.header(r),this.parse(l),this.sourceEl.replaceWith(this.wrapper)}header(e){let t=(e.WhiteTitle?e.WhiteTitle+" ":"")+d(e.White||"")+(e.WhiteElo?" ("+e.WhiteElo+")":""),n=(e.BlackTitle?e.BlackTitle+" ":"")+d(e.Black||"")+(e.BlackElo?" ("+e.BlackElo+")":""),s=h(e.Date),i=(e.Event||"")+(s?", "+s:""),r=document.createElement("h3");r.appendChild(document.createTextNode(t+" – "+n)),r.appendChild(document.createElement("br")),r.appendChild(document.createTextNode(i)),this.wrapper.appendChild(r)}ensure(e,t){if(!e.container){let n=document.createElement("p");n.className=t,this.wrapper.appendChild(n),e.container=n}}handleSAN(e,t){let r=e.replace(/[^a-hKQRBN0-9=O0-]+$/g,"").replace(/0/g,"O");if(!f.isSANCore(r))return p(t.container,e+" "),null;let a=t.baseHistoryLen||0,o=t.chess.history().length,l=a+o,c=l%2==0,h=Math.floor(l/2)+1;"main"===t.type?(c?p(t.container,h+"."+i):t.lastWasInterrupt&&p(t.container,h+"..."+i)):c?p(t.container,h+"."+i):t.lastWasInterrupt&&p(t.container,h+"..."+i),t.prevFen=t.chess.fen(),t.prevHistoryLen=l;let d=t.chess.move(r,{sloppy:!0});if(!d)return p(t.container,e+" "),null;t.lastWasInterrupt=!1;let u=document.createElement("span");return u.className="pgn-move sticky-move",u.dataset.fen=t.chess.fen(),u.textContent=g(e)+" ",t.container.appendChild(u),u}parseComment(e,t,i){let r=t;for(;r<e.length&&"}"!==e[r];)r++;let a=e.substring(t,r).trim();"}"===e[r]&&r++,a=a.replace(/\[%.*?]/g,"").trim();if(!a.length)return r;if("main"===i.type){let t=r;for(;t<e.length&&/\s/.test(e[t]);)t++;let n="";for(;t<e.length&&!/\s/.test(e[t])&&!"(){}".includes(e[t]);)n+=e[t++];n&&(n.match(n)&&(n));n&&n;}let o=a.split("[D]");for(let t=0;t<o.length;t++){let r=o[t].trim();"variation"===i.type?(this.ensure(i,"pgn-variation"),r&&p(i.container," "+r)):(r&&(()=>{let e=document.createElement("p");e.className="pgn-comment",p(e,r),this.wrapper.appendChild(e)})(),i.container=null),t<o.length-1&&u(this.wrapper,i.chess.fen())}return i.lastWasInterrupt=!0,r}parse(e){let t=new Chess,i={type:"main",chess:t,container:null,parent:null,lastWasInterrupt:!1,prevFen:t.fen(),prevHistoryLen:0,baseHistoryLen:null},r=0;for(;r<e.length;){let a=e[r];if(/\s/.test(a)){for(;r<e.length&&/\s/.test(e[r]);)r++;this.ensure(i,"main"===i.type?"pgn-mainline":"pgn-variation"),p(i.container," ");continue}if("("===a){r++;let e=i.prevFen||i.chess.fen(),t="number"==typeof i.prevHistoryLen?i.prevHistoryLen:i.chess.history().length;i={type:"variation",chess:new Chess(e),container:null,parent:i,lastWasInterrupt:!0,prevFen:e,prevHistoryLen:t,baseHistoryLen:t},this.ensure(i,"pgn-variation");continue}if(")"===a){r++,i.parent&&(i=i.parent,i.lastWasInterrupt=!0,i.container=null);continue}if("{"===a){r=this.parseComment(e,r+1,i);continue}let o=r;for(;r<e.length&&!/\s/.test(e[r])&&!"(){}".includes(e[r]);)r++;let l=e.substring(o,r);if(!l)continue;if(/^\[%.*]$/.test(l))continue;if("[D]"===l){u(this.wrapper,i.chess.fen()),i.lastWasInterrupt=!0,i.container=null;continue}if(n.test(l)){if(this.finalResultPrinted)continue;this.finalResultPrinted=!0,this.ensure(i,"main"===i.type?"pgn-mainline":"pgn-variation"),p(i.container,l+" ");continue}if(s.test(l))continue;let c=l.replace(/[^a-hKQRBN0-9=O0-]+$/g,"").replace(/0/g,"O"),h=f.isSANCore(c);if(!h){if("$"===l[0]){let e=+l.slice(1);a[e]&&(this.ensure(i,"main"===i.type?"pgn-mainline":"pgn-variation"),p(i.container,a[e]+" "));continue}if(r.test(l))continue;if(/[A-Za-zÇĞİÖŞÜçğıöşü]/.test(l))"variation"===i.type?(this.ensure(i,"pgn-variation"),p(i.container," "+l)):(()=>{let t=document.createElement("p");t.className="pgn-comment",p(t,l),this.wrapper.appendChild(t)}(),i.container=null,i.lastWasInterrupt=!1);else this.ensure(i,"main"===i.type?"pgn-mainline":"pgn-variation"),p(i.container,l+" ");continue}this.ensure(i,"main"===i.type?"pgn-mainline":"pgn-variation");let d=this.handleSAN(l,i);d||p(i.container,g(l)+" ")}}applyFigurines(){const e={K:"♔",Q:"♕",R:"♖",B:"♗",N:"♘"};this.wrapper.querySelectorAll(".pgn-move").forEach((t=>{let n=t.textContent.match(/^([KQRBN])(.+?)(\s*)$/);n&&(t.textContent=e[n[1]]+n[2]+(n[3]||""))}))}}class m{static renderAll(e){(e||document).querySelectorAll("pgn").forEach((e=>new f(e)))}static init(){l()&&(m.renderAll(document),window.PGNRenderer={run:e=>{m.renderAll(e||document.body)}})}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>m.init())):m.init()})();
